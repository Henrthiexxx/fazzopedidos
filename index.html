<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Cat√°logo Premium</title>
  <style>
    :root{
      --black:#000000;
      --gray-900:#0a0a0a;
      --gray-800:#1a1a1a;
      --gray-700:#2a2a2a;
      --gray-600:#3a3a3a;
      --gray-500:#6b6b6b;
      --gray-400:#9b9b9b;
      --gray-300:#d4d4d4;
      --white:#ffffff;
      --off-white:#f5f5f5;
      --accent:#ffffff;
      --success:#10b981;
      --danger:#ef4444;
      --shadow:0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg:0 20px 40px rgba(0,0,0,0.6);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html{
      -webkit-text-size-adjust:100%;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation
    }
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,sans-serif;
      background:var(--black);
      color:var(--white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overscroll-behavior:none
    }

    /* Previne zoom em inputs no iOS */
    input,select,textarea{
      font-size:16px
    }

    /* Smooth scroll */
    html{
      scroll-behavior:smooth
    }

    /* Backdrop blur para iOS/Android style */
    .backdrop-blur{
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px)
    }

    /* Header Premium */
    .topbar{
      position:sticky;
      top:0;
      z-index:100;
      background:rgba(0,0,0,0.85);
      border-bottom:1px solid var(--gray-800);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px)
    }
    .brand-section{
      display:flex;
      align-items:center;
      gap:12px
    }
    .brand-icon{
      width:40px;
      height:40px;
      background:var(--white);
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px
    }
    .brand-text{
      display:flex;
      flex-direction:column
    }
    .brand-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.02em
    }
    .brand-subtitle{
      font-size:11px;
      color:var(--gray-400);
      text-transform:uppercase;
      letter-spacing:0.05em
    }
    .status-badge{
      display:flex;
      align-items:center;
      gap:6px;
      background:var(--gray-900);
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      color:var(--gray-400);
      border:1px solid var(--gray-800)
    }
    .status-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:var(--success);
      animation:pulse 2s infinite
    }
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.6;transform:scale(0.95)}
    }
    .cartBtn{
      position:relative;
      background:var(--white);
      color:var(--black);
      border:none;
      border-radius:24px;
      padding:10px 20px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 2px 8px rgba(255,255,255,0.1)
    }
    .cartBtn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(255,255,255,0.2)
    }
    .cartBtn:active{
      transform:translateY(0)
    }
    #cartCount{
      background:var(--black);
      color:var(--white);
      padding:2px 8px;
      border-radius:12px;
      font-size:12px;
      font-weight:700;
      min-width:20px;
      text-align:center
    }

    /* Layout */
    .layout{
      max-width:1200px;
      margin:0 auto;
      padding:24px 20px 100px
    }

    /* Search Premium */
    .search-section{
      margin-bottom:32px
    }
    .search-wrapper{
      position:relative;
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      border-radius:16px;
      transition:all 0.3s;
      overflow:hidden
    }
    .search-wrapper:focus-within{
      border-color:var(--white);
      box-shadow:0 0 0 4px rgba(255,255,255,0.1)
    }
    .search-icon{
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      font-size:18px;
      color:var(--gray-500);
      pointer-events:none
    }
    .search-input{
      width:100%;
      background:transparent;
      border:none;
      padding:16px 16px 16px 48px;
      font-size:16px;
      color:var(--white);
      outline:none
    }
    .search-input::placeholder{
      color:var(--gray-500)
    }
    .search-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:16px;
      padding:0 4px
    }
    .count-badge{
      font-size:13px;
      color:var(--gray-400)
    }
    .pills{
      display:flex;
      gap:8px
    }
    .pill{
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      color:var(--gray-400);
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      cursor:pointer;
      transition:all 0.2s
    }
    .pill:hover{
      border-color:var(--gray-600)
    }
    .pill[data-active="true"]{
      background:var(--white);
      color:var(--black);
      border-color:var(--white)
    }

    /* Categories Premium */
    .cat{
      margin-bottom:48px
    }
    .cat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      padding:0 4px
    }
    .cat-title{
      font-size:22px;
      font-weight:700;
      letter-spacing:-0.02em
    }
    .cat-count{
      background:var(--gray-900);
      color:var(--gray-400);
      padding:6px 14px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--gray-800)
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px
    }

    /* Product Cards Premium */
    .card{
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      border-radius:20px;
      padding:20px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      cursor:pointer
    }
    .card:hover{
      border-color:var(--gray-600);
      transform:translateY(-4px);
      box-shadow:var(--shadow)
    }
    .card-content{
      display:flex;
      flex-direction:column;
      gap:12px
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px
    }
    .nm{
      font-size:16px;
      font-weight:600;
      line-height:1.4;
      flex:1
    }
    .pr{
      font-size:18px;
      font-weight:700;
      color:var(--white);
      white-space:nowrap
    }
    .hint{
      font-size:12px;
      color:var(--gray-500);
      display:flex;
      flex-wrap:wrap;
      gap:8px
    }
    .hint span{
      display:inline-flex;
      align-items:center;
      gap:4px
    }
    .btnAdd{
      width:100%;
      background:var(--white);
      color:var(--black);
      border:none;
      border-radius:12px;
      padding:12px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      margin-top:8px
    }
    .btnAdd:hover{
      background:var(--off-white);
      transform:scale(1.02)
    }
    .btnAdd:active{
      transform:scale(0.98)
    }

    /* Cart Premium */
    .cart{
      position:fixed;
      top:0;
      right:-100%;
      width:420px;
      max-width:100vw;
      height:100vh;
      background:var(--black);
      border-left:1px solid var(--gray-800);
      transition:right 0.4s cubic-bezier(0.4,0,0.2,1);
      z-index:200;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow-lg)
    }
    .cart.open{
      right:0
    }
    .cartHead{
      padding:20px;
      border-bottom:1px solid var(--gray-800);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(0,0,0,0.95);
      backdrop-filter:blur(20px)
    }
    .cartTitle{
      font-size:20px;
      font-weight:700;
      letter-spacing:-0.02em
    }
    .iconBtn{
      width:36px;
      height:36px;
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      color:var(--white);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.2s;
      font-size:16px
    }
    .iconBtn:hover{
      background:var(--gray-800);
      transform:rotate(90deg)
    }
    .cartBody{
      flex:1;
      overflow-y:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px
    }
    .cartBody::-webkit-scrollbar{
      width:8px
    }
    .cartBody::-webkit-scrollbar-track{
      background:transparent
    }
    .cartBody::-webkit-scrollbar-thumb{
      background:var(--gray-800);
      border-radius:4px
    }
    .cartItem{
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      border-radius:16px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      transition:border 0.2s
    }
    .cartItem:hover{
      border-color:var(--gray-700)
    }
    .itemHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start
    }
    .itemHeader b{
      font-size:15px;
      font-weight:600
    }
    .itemMeta{
      font-size:12px;
      color:var(--gray-500);
      margin-top:4px
    }
    .itemPrice{
      font-size:16px;
      font-weight:700;
      color:var(--white)
    }
    .itemControls{
      display:flex;
      align-items:center;
      justify-content:space-between
    }
    .qty{
      display:flex;
      align-items:center;
      gap:12px;
      background:var(--gray-800);
      padding:6px;
      border-radius:12px
    }
    .qty button{
      width:32px;
      height:32px;
      background:var(--gray-900);
      border:1px solid var(--gray-700);
      color:var(--white);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      transition:all 0.2s
    }
    .qty button:hover{
      background:var(--gray-700);
      border-color:var(--gray-600)
    }
    .qty b{
      min-width:24px;
      text-align:center;
      font-size:15px
    }
    .btn-del{
      background:transparent;
      border:none;
      color:var(--danger);
      cursor:pointer;
      font-size:18px;
      padding:8px;
      transition:all 0.2s;
      border-radius:8px
    }
    .btn-del:hover{
      background:rgba(239,68,68,0.1)
    }
    .cartFoot{
      border-top:1px solid var(--gray-800);
      padding:20px;
      background:rgba(0,0,0,0.95);
      backdrop-filter:blur(20px)
    }
    .summary{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:20px
    }
    .line{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      color:var(--gray-400)
    }
    .line.total{
      font-size:20px;
      color:var(--white);
      font-weight:700;
      padding-top:12px;
      border-top:1px solid var(--gray-800)
    }
    .actions{
      display:flex;
      gap:12px
    }
    .btn{
      flex:1;
      padding:14px;
      border-radius:12px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      border:none
    }
    .btn.ghost{
      background:var(--gray-900);
      color:var(--white);
      border:1px solid var(--gray-800)
    }
    .btn.ghost:hover{
      background:var(--gray-800)
    }
    .btn.primary{
      flex:2;
      background:var(--white);
      color:var(--black)
    }
    .btn.primary:hover{
      background:var(--off-white);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(255,255,255,0.2)
    }

    /* Modal Premium */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(8px);
      z-index:300;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      opacity:0;
      animation:fadeIn 0.3s forwards
    }
    @keyframes fadeIn{
      to{opacity:1}
    }
    .modal{
      background:var(--gray-900);
      border:1px solid var(--gray-800);
      border-radius:24px;
      width:100%;
      max-width:600px;
      max-height:90vh;
      overflow:hidden;
      box-shadow:var(--shadow-lg);
      transform:scale(0.9);
      animation:scaleIn 0.3s forwards
    }
    @keyframes scaleIn{
      to{transform:scale(1)}
    }
    .modal-header{
      padding:24px;
      border-bottom:1px solid var(--gray-800);
      display:flex;
      align-items:center;
      justify-content:space-between
    }
    .modal-title{
      font-size:20px;
      font-weight:700;
      letter-spacing:-0.02em
    }
    .modal-body{
      padding:24px;
      overflow-y:auto;
      max-height:60vh
    }
    .modal-body::-webkit-scrollbar{
      width:8px
    }
    .modal-body::-webkit-scrollbar-track{
      background:transparent
    }
    .modal-body::-webkit-scrollbar-thumb{
      background:var(--gray-800);
      border-radius:4px
    }
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px
    }
    .form-field{
      display:flex;
      flex-direction:column;
      gap:8px
    }
    .form-field.full{
      grid-column:1/-1
    }
    .form-label{
      font-size:13px;
      font-weight:600;
      color:var(--gray-400);
      text-transform:uppercase;
      letter-spacing:0.05em
    }
    .form-input,
    .form-select{
      background:var(--gray-800);
      border:1px solid var(--gray-700);
      color:var(--white);
      padding:14px;
      border-radius:12px;
      font-size:15px;
      outline:none;
      transition:all 0.2s
    }
    .form-input:focus,
    .form-select:focus{
      border-color:var(--white);
      box-shadow:0 0 0 4px rgba(255,255,255,0.1)
    }
    .form-input::placeholder{
      color:var(--gray-600)
    }
    .form-hint{
      font-size:12px;
      color:var(--gray-500)
    }
    .form-badge{
      display:inline-block;
      background:var(--white);
      color:var(--black);
      padding:2px 8px;
      border-radius:8px;
      font-size:11px;
      font-weight:700;
      margin-left:8px
    }
    .modal-summary{
      background:var(--gray-800);
      border-radius:16px;
      padding:16px;
      margin-top:20px
    }
    .modal-summary .line{
      padding:8px 0
    }
    .modal-footer{
      padding:24px;
      border-top:1px solid var(--gray-800);
      display:flex;
      gap:12px
    }
    .error-msg{
      color:var(--danger);
      font-size:13px;
      margin-top:12px;
      padding:12px;
      background:rgba(239,68,68,0.1);
      border-radius:8px;
      border:1px solid rgba(239,68,68,0.2)
    }

    /* Empty States */
    .empty{
      text-align:center;
      padding:80px 20px;
      color:var(--gray-500)
    }
    .empty-icon{
      font-size:64px;
      margin-bottom:16px;
      opacity:0.5
    }

    /* Footer */
    .foot{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:rgba(0,0,0,0.95);
      backdrop-filter:blur(20px);
      border-top:1px solid var(--gray-800);
      padding:12px 20px;
      text-align:center;
      font-size:12px;
      color:var(--gray-500);
      z-index:90
    }

    /* Loading Animation */
    .loading{
      display:inline-block;
      width:20px;
      height:20px;
      border:2px solid var(--gray-800);
      border-top-color:var(--white);
      border-radius:50%;
      animation:spin 0.6s linear infinite
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    /* Responsive */
    @media (max-width:768px){
      /* Header Mobile */
      .topbar{
        padding:12px 16px;
        flex-wrap:wrap;
        gap:8px
      }
      .brand-section{
        gap:8px
      }
      .brand-icon{
        width:32px;
        height:32px;
        font-size:16px
      }
      .brand-title{
        font-size:15px
      }
      .brand-subtitle{
        font-size:10px
      }
      .status-badge{
        order:3;
        width:100%;
        justify-content:center;
        font-size:11px;
        padding:4px 10px
      }
      .cartBtn{
        padding:8px 16px;
        font-size:13px
      }
      #cartCount{
        padding:1px 6px;
        font-size:11px
      }

      /* Layout Mobile */
      .layout{
        padding:16px 12px 100px
      }

      /* Search Mobile */
      .search-section{
        margin-bottom:24px
      }
      .search-wrapper{
        border-radius:12px
      }
      .search-input{
        padding:14px 14px 14px 44px;
        font-size:15px
      }
      .search-icon{
        left:14px;
        font-size:16px
      }
      .search-meta{
        margin-top:12px;
        flex-direction:column;
        align-items:flex-start;
        gap:10px
      }
      .pills{
        width:100%;
        justify-content:space-between
      }

      /* Categories Mobile */
      .cat{
        margin-bottom:32px
      }
      .cat-header{
        margin-bottom:16px
      }
      .cat-title{
        font-size:18px
      }
      .cat-count{
        padding:4px 10px;
        font-size:11px
      }

      /* Grid Mobile */
      .grid{
        grid-template-columns:1fr;
        gap:12px
      }

      /* Cards Mobile */
      .card{
        padding:16px;
        border-radius:16px
      }
      .nm{
        font-size:15px
      }
      .pr{
        font-size:16px
      }
      .hint{
        font-size:11px
      }
      .btnAdd{
        padding:10px;
        font-size:13px;
        border-radius:10px
      }

      /* Cart Mobile */
      .cart{
        width:100%;
        right:-100%
      }
      .cartHead{
        padding:16px
      }
      .cartTitle{
        font-size:18px
      }
      .iconBtn{
        width:32px;
        height:32px;
        font-size:14px
      }
      .cartBody{
        padding:12px
      }
      .cartItem{
        padding:12px;
        border-radius:12px
      }
      .itemHeader b{
        font-size:14px
      }
      .itemMeta{
        font-size:11px
      }
      .itemPrice{
        font-size:14px
      }
      .qty{
        padding:4px;
        gap:8px
      }
      .qty button{
        width:28px;
        height:28px;
        font-size:14px
      }
      .qty b{
        font-size:14px
      }
      .cartFoot{
        padding:16px
      }
      .summary{
        gap:10px;
        margin-bottom:16px
      }
      .line{
        font-size:13px
      }
      .line.total{
        font-size:18px;
        padding-top:10px
      }
      .btn{
        padding:12px;
        font-size:14px
      }

      /* Modal Mobile */
      .modal-backdrop{
        padding:0;
        align-items:flex-end
      }
      .modal{
        max-width:100%;
        border-radius:20px 20px 0 0;
        max-height:85vh;
        animation:slideUp 0.3s forwards
      }
      @keyframes slideUp{
        from{transform:translateY(100%)}
        to{transform:translateY(0)}
      }
      .modal-header{
        padding:16px
      }
      .modal-title{
        font-size:18px
      }
      .modal-body{
        padding:16px;
        max-height:55vh
      }
      .modal-footer{
        padding:16px;
        flex-direction:column-reverse
      }
      .modal-footer .btn{
        width:100%;
        flex:1
      }
      
      /* Form Mobile */
      .form-grid{
        grid-template-columns:1fr;
        gap:16px
      }
      .form-label{
        font-size:12px
      }
      .form-input,
      .form-select{
        padding:12px;
        font-size:14px;
        border-radius:10px
      }
      .form-badge{
        font-size:10px;
        padding:2px 6px
      }
      .modal-summary{
        padding:12px;
        border-radius:12px
      }
      .modal-summary .line{
        padding:6px 0;
        font-size:13px
      }
      .error-msg{
        font-size:12px;
        padding:10px
      }

      /* Footer Mobile */
      .foot{
        padding:10px 16px;
        font-size:11px
      }

      /* Empty States Mobile */
      .empty{
        padding:60px 20px
      }
      .empty-icon{
        font-size:48px
      }
    }

    /* Extra Small Mobile */
    @media (max-width:380px){
      .topbar{
        padding:10px 12px
      }
      .brand-title{
        font-size:14px
      }
      .layout{
        padding:12px 10px 100px
      }
      .search-input{
        padding:12px 12px 12px 40px;
        font-size:14px
      }
      .cat-title{
        font-size:16px
      }
      .card{
        padding:14px
      }
      .nm{
        font-size:14px
      }
      .pr{
        font-size:15px
      }
      .btnAdd{
        padding:9px;
        font-size:12px
      }
      .cartItem{
        padding:10px
      }
      .modal-body{
        padding:12px
      }
      .form-input,
      .form-select{
        padding:10px;
        font-size:13px
      }
    }

    /* Landscape Mobile */
    @media (max-width:768px) and (orientation:landscape){
      .layout{
        padding-bottom:60px
      }
      .modal{
        max-height:90vh
      }
      .modal-body{
        max-height:65vh
      }
      .cartBody{
        max-height:50vh
      }
    }

    /* Touch Targets - Aumenta √°rea de toque */
    @media (hover: none) and (pointer: coarse){
      .btnAdd,
      .cartBtn,
      .btn,
      .iconBtn,
      .qty button{
        min-height:44px
      }
      .pill{
        min-height:36px;
        padding:8px 12px
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand-section">
      <div class="brand-icon">üõçÔ∏è</div>
      <div class="brand-text">
        <div class="brand-title">Cat√°logo Premium</div>
        <div class="brand-subtitle">Delivery</div>
      </div>
    </div>
    <div class="status-badge">
      <span class="status-dot"></span>
      <span id="meta">Online</span>
    </div>
    <button id="toggleCart" class="cartBtn">
      Carrinho
      <span id="cartCount" style="display:none">0</span>
    </button>
  </header>

  <div class="layout">
    <div class="search-section">
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input 
          id="q" 
          class="search-input" 
          type="text" 
          placeholder="Buscar produtos..."
          autocomplete="off"
        />
      </div>
      <div class="search-meta">
        <div class="count-badge" id="count">0 produtos</div>
        <div class="pills">
          <span class="pill" id="pillStock">Filtros</span>
        </div>
      </div>
    </div>

    <div id="catalog"></div>
    <div id="empty" class="empty" hidden>
      <div class="empty-icon">üì≠</div>
      <div>Nenhum produto encontrado</div>
    </div>
  </div>

  <aside id="cartPanel" class="cart">
    <div class="cartHead">
      <div class="cartTitle">Carrinho</div>
      <button id="closeCart" class="iconBtn">‚úï</button>
    </div>
    <div id="cartBody" class="cartBody">
      <div class="empty">
        <div class="empty-icon">üõí</div>
        <div>Carrinho vazio</div>
      </div>
    </div>
    <div class="cartFoot">
      <div class="summary">
        <div class="line">
          <span>Itens</span>
          <span id="cartItems">0</span>
        </div>
        <div class="line total">
          <b>Total</b>
          <b id="cartTotal">R$ 0,00</b>
        </div>
      </div>
      <div class="actions">
        <button id="clearCart" class="btn ghost">Limpar</button>
        <button id="checkout" class="btn primary">Finalizar Pedido</button>
      </div>
    </div>
  </aside>

  <footer class="foot">
    <span id="ts">‚Äî</span>
  </footer>
<script>
(function (global) {
  const LS_CATS = 'categorias';

  function loadCats() {
    try { return JSON.parse(localStorage.getItem(LS_CATS) || '[]'); }
    catch { return []; }
  }
  function buildMap(arr) {
    const m = new Map();
    for (const c of (arr||[])) if (c && c.id) m.set(String(c.id), c);
    return m;
  }
  function pathFromId(id, map) {
    const p = [];
    let cur = map.get(String(id));
    while (cur) {
      p.unshift(cur.nome);
      cur = cur.parentId ? map.get(String(cur.parentId)) : null;
    }
    return p.join(' / ');
  }

  /**
   * Converte categoriaId -> categoria (string caminho) sem alterar UI.
   * - L√™ categorias do localStorage por padr√£o (ou aceite um array em `categoriasOverride`)
   * - Retorna um NOVO array de produtos (n√£o muta o original)
   */
  function attachCategoriaNomeFromId(produtos, categoriasOverride) {
    const catsArr = Array.isArray(categoriasOverride) ? categoriasOverride : loadCats();
    const map = buildMap(catsArr);

    return (produtos || []).map((p) => {
      const out = { ...p };
      // Se j√° vier 'categoria' (legado), apenas normaliza
      if (out.categoria && typeof out.categoria === 'string') {
        out.categoria = out.categoria.trim();
        return out;
      }
      // Se vier no formato novo (categoriaId), monta caminho
      if (out.categoriaId) {
        const caminho = pathFromId(out.categoriaId, map);
        if (caminho) out.categoria = caminho; // <- chave usada hoje no agrupamento
      }
      // Fallback: deixa vazio; seu agrupamento j√° trata "Sem categoria"
      return out;
    });
  }

  // exp√µe global
  global.smartCategorias = { attachCategoriaNomeFromId };
})(window);
</script>

  <script type="module">
    // Inline catalog.js com estilos premium
    const moneyBR = (n)=> Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const collator = new Intl.Collator('pt-BR', { sensitivity:'base', numeric:true });

    const LS_PRODUCTS_VIEW = 'catalog_products_view';
    const LS_CART = 'catalog_cart';
    const LS_CART_UPDATED = 'catalog_cart_updated_at';

    const els = {
      meta: document.getElementById('meta'),
      q: document.getElementById('q'),
      catalog: document.getElementById('catalog'),
      empty: document.getElementById('empty'),
      count: document.getElementById('count'),
      ts: document.getElementById('ts'),
      pillStock: document.getElementById('pillStock'),
      pillMin: document.getElementById('pillMin'),
      cartBtn: document.getElementById('toggleCart'),
      closeCart: document.getElementById('closeCart'),
      cartPanel: document.getElementById('cartPanel'),
      cartBody: document.getElementById('cartBody'),
      cartItems: document.getElementById('cartItems'),
      cartTotal: document.getElementById('cartTotal'),
      clearCart: document.getElementById('clearCart'),
      checkout: document.getElementById('checkout'),
      cartCount: document.getElementById('cartCount'),
    };

    const params = new URLSearchParams(location.search);
    const qsStock = params.get('stock');
    const FILTERS = {
      hideNoStock: qsStock === null ? true : qsStock === '1',
      hideMinZero: params.get('min') === '1',
    };

    let db, unsub = null;
    let rawSrc = [];
    let all = [];
    let indexById = new Map();
    let cart = loadCart();

    wireUI();

    (async function bootstrap(){
      try{
        await initFirebase();
        await firstLoad();
        setupRealtime();
      }catch(e){
        console.error('[catalog] bootstrap error', e);
        loadFromLocal();
      }
    })();

    async function initFirebase(){
      const mod = await import('./server.js');
      db = mod.db;
      try { if (mod.ready) await mod.ready; } catch {}
    }

    function normalize(raw){
      if (raw == null) return [];
      let x = raw;
      if (typeof x === 'string') {
        const s = x.trim();
        try { x = JSON.parse(s); }
        catch { try { x = JSON.parse('['+s.replace(/}\s*[\n,]?\s*\{/g,'},{')+']'); } catch { return []; } }
      }
      let arr = Array.isArray(x) ? x : (x && typeof x === 'object' ? Object.values(x) : []);
      return arr.map(it => typeof it==='string' ? (()=>{try{return JSON.parse(it)}catch{return null}})() : it).filter(Boolean);
    }

    function isActive(p){
      if(!p) return false;
      if (p.ativo === false || p.ativo === 0 || p.ativo === 'false' || p.ativo === '0') return false;
      if ('status' in p) {
        const s = String(p.status).toLowerCase();
        if (['inativo','inactive','off','0','false'].includes(s)) return false;
      }
      return true;
    }

    function minVal(p){ const n = Number(p?.min); return Number.isFinite(n) ? n : null; }
    
    function stockVal(p){
      const names = ['estoque','qtd','quantidade','saldo','qtdEstoque','estoqueAtual','stock'];
      for (const k of names) {
        const v = p?.[k];
        const n = Number(v);
        if (Number.isFinite(n)) return n;
      }
      return null;
    }

    function productPrice(p){
      const cand = ['precoVenda','preco','price','valor','valorVenda','unitPrice'];
      for (const k of cand) {
        const v = Number(p?.[k]);
        if (!Number.isNaN(v) && v != null) return v;
      }
      return 0;
    }

    function productId(p){
      const base = p?.id ?? p?.codigoBarras ?? `${p?.nome || 'item'}|${productPrice(p)}`;
      return String(base);
    }

    function buildLocalView(raw){
      let out = normalize(raw).filter(isActive);
      if (FILTERS.hideMinZero) out = out.filter(p => minVal(p) !== 0);
      if (FILTERS.hideNoStock) out = out.filter(p => {
        const s = stockVal(p);
        return s === null ? true : s > 0;
      });
      indexById = new Map();
      for (const p of out) indexById.set(productId(p), p);
      out.sort((a,b)=> collator.compare(a?.nome?.toString?.()||'', b?.nome?.toString?.()||''));
      return out;
    }

    function groupByCategory(arr){
      const map = new Map();
      for (const p of arr) {
        let c = (p?.categoria ?? '').toString().trim();
        if (!c) c = 'Sem categoria';
        if (!map.has(c)) map.set(c, []);
        map.get(c).push(p);
      }
      const cats = Array.from(map.keys()).sort((a,b)=> collator.compare(a,b));
      return cats.map(cat => ({
        cat,
        items: map.get(cat).slice().sort((a,b)=> collator.compare(a?.nome?.toString?.()||'', b?.nome?.toString?.()||'')),
      }));
    }

    function render(filterText=""){
      const q = (filterText||"").toLowerCase();
      const filtered = all.filter(p =>
        !q ||
        (p.nome||'').toLowerCase().includes(q) ||
        (p.codigoBarras||'').toLowerCase().includes(q)
      );
      const groups = groupByCategory(filtered);

      let totalShown = 0;
      const html = groups.map(g => {
        if (!g.items.length) return '';
        totalShown += g.items.length;
        const cards = g.items.map(p => {
          const id = productId(p);
          return `
            <div class="card" data-id="${id}">
              <div class="card-content">
                <div class="card-header">
                  <div class="nm">${p.nome || '‚Äî'}</div>
                  <div class="pr">${moneyBR(productPrice(p))}</div>
                </div>
                <div class="hint">
                  ${p.codigoBarras ? '<span>üì¶ #'+p.codigoBarras+'</span>' : ''}
                  ${p.categoria ? '<span>üè∑Ô∏è '+p.categoria+'</span>' : ''}
                </div>
                <button class="btnAdd" data-add="${id}" type="button">Adicionar ao Carrinho</button>
              </div>
            </div>
          `;
        }).join('');
        return `
          <section class="cat">
            <div class="cat-header">
              <div class="cat-title">${g.cat}</div>
              <div class="cat-count">${g.items.length}</div>
            </div>
            <div class="grid">${cards}</div>
          </section>
        `;
      }).join('');

      els.catalog.innerHTML = html;
      els.count.textContent = `${totalShown} produto${totalShown===1?'':'s'}`;
      els.empty.hidden = totalShown > 0;
    }

    function updateMeta(viewCount, totalSrc, online=true){
      const dt = new Date();
      els.meta.textContent = online ? 'Online' : 'Offline';
      els.ts.textContent = `Atualizado ${dt.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'})}`;
    }

    async function firstLoad(){
      const ref = db.collection('data').doc('keys');
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};
      
      rawSrc = smartCategorias.attachCategoriaNomeFromId(d.produtos || []);

      rawSrc = d.produtos || [];
      const view = buildLocalView(rawSrc);
      localStorage.setItem(LS_PRODUCTS_VIEW, JSON.stringify(view));
      all = view;
      render(els.q.value);
      updateMeta(view.length, normalize(rawSrc).length, true);
    }

    function setupRealtime(){
      const ref = db.collection('data').doc('keys');
      unsub = ref.onSnapshot(doc => {
        const d = doc.exists ? doc.data() : {};
        rawSrc = d.produtos || [];
        const view = buildLocalView(rawSrc);
        localStorage.setItem(LS_PRODUCTS_VIEW, JSON.stringify(view));
        all = view;
        render(els.q.value);
        updateMeta(view.length, normalize(rawSrc).length, true);
      }, err => {
        console.error('[catalog] listener error', err);
      });
    }

    function loadFromLocal(){
      try{
        const local = JSON.parse(localStorage.getItem(LS_PRODUCTS_VIEW) || '[]');
        all = Array.isArray(local) ? local : [];
        render(els.q.value);
        updateMeta(all.length, all.length, false);
      }catch{}
    }

    function wireUI(){
      els.q?.addEventListener('input', () => render(els.q.value));
      els.cartBtn?.addEventListener('click', () => els.cartPanel?.classList.add('open'));
      els.closeCart?.addEventListener('click', () => els.cartPanel?.classList.remove('open'));

      els.catalog?.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-add]');
        if (!btn) return;
        const id = btn.dataset.add;
        const p = indexById.get(id);
        if (!p) return;
        addToCart(fromProduct(p));
      });

      els.cartBody?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const { id, act } = btn.dataset;
        if (act === 'inc') incItem(id, +1);
        if (act === 'dec') incItem(id, -1);
        if (act === 'del') removeItem(id);
      });

      els.clearCart?.addEventListener('click', async () => {
        if (!cart.length) return;
        const ok = await showConfirm('Deseja limpar o carrinho?', 'Limpar', 'Cancelar');
        if (ok) { cart = []; saveCart(); }
      });

      els.checkout?.addEventListener('click', doCheckout);
      renderCart();
    }

    async function showAlert(title, message, buttonText = 'OK'){
      return new Promise(resolve => {
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.innerHTML = `
          <div class="modal" style="max-width:420px">
            <div class="modal-header">
              <div class="modal-title">${title}</div>
            </div>
            <div class="modal-body">
              <p style="color:var(--gray-400);line-height:1.6">${message}</p>
            </div>
            <div class="modal-footer">
              <button class="btn primary" id="btnOk" style="width:100%">${buttonText}</button>
            </div>
          </div>
        `;
        document.body.appendChild(backdrop);
        const close = () => { backdrop.remove(); resolve(); };
        backdrop.querySelector('#btnOk').onclick = close;
      });
    }

    async function showSuccess(title, message, buttonText = 'OK'){
      return new Promise(resolve => {
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.innerHTML = `
          <div class="modal" style="max-width:420px">
            <div class="modal-header">
              <div class="modal-title">‚úÖ ${title}</div>
            </div>
            <div class="modal-body">
              <p style="color:var(--gray-400);line-height:1.6;text-align:center">${message}</p>
            </div>
            <div class="modal-footer">
              <button class="btn primary" id="btnOk" style="width:100%">${buttonText}</button>
            </div>
          </div>
        `;
        document.body.appendChild(backdrop);
        const close = () => { backdrop.remove(); resolve(); };
        backdrop.querySelector('#btnOk').onclick = close;
      });
    }

    function showLoading(message = 'Carregando...'){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.innerHTML = `
        <div class="modal" style="max-width:320px">
          <div class="modal-body" style="text-align:center;padding:40px 24px">
            <div class="loading" style="margin:0 auto 16px"></div>
            <p style="color:var(--gray-400);margin:0">${message}</p>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);
      return {
        close: () => backdrop.remove(),
        update: (msg) => {
          const p = backdrop.querySelector('p');
          if (p) p.textContent = msg;
        }
      };
    }

    async function showConfirm(message, confirmText, cancelText){
      return new Promise(resolve => {
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.innerHTML = `
          <div class="modal" style="max-width:420px">
            <div class="modal-header">
              <div class="modal-title">Confirma√ß√£o</div>
            </div>
            <div class="modal-body">
              <p style="color:var(--gray-400);line-height:1.6">${message}</p>
            </div>
            <div class="modal-footer">
              <button class="btn ghost" id="btnCancel">${cancelText}</button>
              <button class="btn primary" id="btnConfirm">${confirmText}</button>
            </div>
          </div>
        `;
        document.body.appendChild(backdrop);
        const close = (result) => { backdrop.remove(); resolve(result); };
        backdrop.querySelector('#btnCancel').onclick = () => close(false);
        backdrop.querySelector('#btnConfirm').onclick = () => close(true);
        backdrop.addEventListener('click', (e) => { if(e.target===backdrop) close(false); });
      });
    }

    async function doCheckout(){
      if (!cart.length) {
        await showAlert('Carrinho vazio', 'Adicione produtos antes de finalizar o pedido.');
        return;
      }

      const snap = cartSnapshot();
      const form = await openCheckoutModal(snap);
      if (!form) return;

      const subtotal = snap.totals.subtotal;
      const cartDisc = snap.totals.discount;
      const payDisc = form.paymentDiscountApplied || 0;
      const deliveryFee = form.deliveryFee || 0;
      const total = +(subtotal - (cartDisc > 0 ? cartDisc : payDisc) + deliveryFee).toFixed(2);

      const order = {
        status: 'new',
        createdAt: window.firebase?.firestore?.FieldValue?.serverTimestamp?.() ?? null,
        createdAtClient: Date.now(),
        updatedAt: window.firebase?.firestore?.FieldValue?.serverTimestamp?.() ?? null,
        source: { from:'catalog-premium', domain: location.host, ua: navigator.userAgent },
        customer: {
          name: form.name,
          phone: form.phone,
          address: { street: form.street, number: form.number || '', district: form.district }
        },
        payment: {
          methodId: form.payment?.id || null,
          methodName: form.payment?.name || null,
          discountApplied: payDisc
        },
        delivery: {
          fee: deliveryFee
        },
        items: snap.items,
        totals: { subtotal, discount: cartDisc, paymentDiscount: payDisc, deliveryFee, total }
      };

      const loading = showLoading('Enviando seu pedido...');

      try{
        const { db, ready } = await import('./server.js');
        await ready;
        const ref = db.collection('orders').doc();
        await ref.set(order);
        
        localStorage.setItem('checkout_last_order_id', ref.id);
        
        cart = [];
        saveCart();
        renderCart();
        els.cartPanel.classList.remove('open');
        
        loading.close();
        
        await showSuccess(
          'Pedido Enviado!',
          `Seu pedido foi enviado com sucesso! Voc√™ ser√° redirecionado para acompanhar o status.`,
          'Acompanhar Pedido'
        );
        
        window.location.href = `status.html?id=${ref.id}`;
      }catch(err){
        loading.close();
        console.error('[checkout] erro:', err);
        await showAlert(
          'Erro ao Enviar',
          'N√£o foi poss√≠vel enviar seu pedido. Verifique sua conex√£o e tente novamente.',
          'Entendi'
        );
      }
    }

    function cartSnapshot(){
      const items = cart.map(it => ({
        id: it.id,
        name: it.name,
        code: it.code || null,
        unitPrice: +Number(it.unitPrice || 0).toFixed(2),
        qty: +Number(it.qty || 1).toFixed(0),
        lineTotal: +Number((it.unitPrice || 0) * (it.qty || 1)).toFixed(2),
      }));
      const subtotal = +items.reduce((s,i)=>s+i.lineTotal,0).toFixed(2);
      const discount = 0;
      const total = +(subtotal - discount).toFixed(2);
      return { items, totals:{ subtotal, discount, total } };
    }

    async function openCheckoutModal(cart){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">Finalizar Pedido</div>
            <button class="iconBtn" id="modalClose">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-field full">
                <label class="form-label">Nome Completo <span class="form-badge">Obrigat√≥rio</span></label>
                <input class="form-input" id="ckName" placeholder="Seu nome completo" />
              </div>
              <div class="form-field full">
                <label class="form-label">Telefone <span class="form-badge">Obrigat√≥rio</span></label>
                <input class="form-input" id="ckPhone" placeholder="(00) 0 0000-0000" inputmode="numeric" />
              </div>
              <div class="form-field full">
                <label class="form-label">Endere√ßo <span class="form-badge">Obrigat√≥rio</span></label>
                <input class="form-input" id="ckStreet" placeholder="Rua / Avenida" />
              </div>
              <div class="form-field">
                <label class="form-label">N√∫mero</label>
                <input class="form-input" id="ckNumber" placeholder="N¬∫" />
              </div>
              <div class="form-field">
                <label class="form-label">Bairro <span class="form-badge">Obrigat√≥rio</span></label>
                <select class="form-select" id="ckDistrict">
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div class="form-field full">
                <label class="form-label">Forma de Pagamento</label>
                <select class="form-select" id="ckPayment"></select>
              </div>
              <div class="modal-summary full">
                <div class="line">
                  <span>Subtotal</span>
                  <span id="ckSubtotal">${moneyBR(cart.totals.subtotal)}</span>
                </div>
                <div class="line">
                  <span>Desconto</span>
                  <span id="ckDiscount">R$ 0,00</span>
                </div>
                <div class="line">
                  <span>Taxa de Entrega</span>
                  <span id="ckDelivery">R$ 0,00</span>
                </div>
                <div class="line total">
                  <b>Total</b>
                  <b id="ckTotal">${moneyBR(cart.totals.total)}</b>
                </div>
              </div>
            </div>
            <div id="ckError" class="error-msg" style="display:none"></div>
          </div>
          <div class="modal-footer">
            <button class="btn ghost" id="modalCancel">Cancelar</button>
            <button class="btn primary" id="modalConfirm">Enviar Pedido</button>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);

      const ui = {
        name: backdrop.querySelector('#ckName'),
        phone: backdrop.querySelector('#ckPhone'),
        street: backdrop.querySelector('#ckStreet'),
        number: backdrop.querySelector('#ckNumber'),
        district: backdrop.querySelector('#ckDistrict'),
        payment: backdrop.querySelector('#ckPayment'),
        subtotal: backdrop.querySelector('#ckSubtotal'),
        discount: backdrop.querySelector('#ckDiscount'),
        delivery: backdrop.querySelector('#ckDelivery'),
        total: backdrop.querySelector('#ckTotal'),
        error: backdrop.querySelector('#ckError'),
      };

      const ls = (k,d='')=>{ try{return localStorage.getItem(k)??d}catch{return d} };
      ui.name.value = ls('customer_name');
      ui.phone.value = ls('customer_phone');
      ui.street.value = ls('customer_street');
      ui.number.value = ls('customer_number');

      const { list: districts, fees: feeMap } = await loadDistrictsAndFees();
      const lastDistrict = ls('customer_district');
      for (const name of districts) {
        const fee = Number(feeMap[name] || 0);
        const opt = document.createElement('option');
        opt.value = name;
        opt.dataset.fee = String(fee);
        opt.textContent = fee ? `${name} ‚Äî ${moneyBR(fee)}` : name;
        if (name === lastDistrict) opt.selected = true;
        ui.district.appendChild(opt);
      }

      const payOpts = await loadOrEnsurePaymentOptions();
      for (const p of payOpts) {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        if (p.id === ls('payment_method_id')) opt.selected = true;
        ui.payment.appendChild(opt);
      }

      const refreshTotals = () => {
        const subtotal = cart.totals.subtotal;
        const chosen = payOpts.find(p => p.id === ui.payment.value);
        const payDisc = calcPayDiscount(subtotal, chosen?.discount);
        const sel = ui.district.options[ui.district.selectedIndex];
        const shipFee = Number(sel?.dataset?.fee || 0);
        const total = Math.max(0, subtotal - payDisc) + shipFee;
        ui.discount.textContent = moneyBR(payDisc);
        ui.delivery.textContent = moneyBR(shipFee);
        ui.total.textContent = moneyBR(total);
      };

      ui.payment.addEventListener('change', refreshTotals);
      ui.district.addEventListener('change', refreshTotals);
      ui.phone.addEventListener('input', () => {
        const d = ui.phone.value.replace(/\D+/g,'').slice(0,11);
        let v = d;
        if (v.length>0) v='('+v;
        if (v.length>3) v=v.slice(0,3)+') '+v.slice(3);
        if (v.length>10) v=v.slice(0,10)+'-'+v.slice(10);
        ui.phone.value = v;
      });
      refreshTotals();

      return new Promise(resolve => {
        const close = (payload) => { backdrop.remove(); resolve(payload); };
        backdrop.querySelector('#modalClose').onclick = () => close(null);
        backdrop.querySelector('#modalCancel').onclick = () => close(null);
        backdrop.addEventListener('click', (e) => { if(e.target===backdrop) close(null); });
        backdrop.querySelector('#modalConfirm').onclick = () => {
          const name = ui.name.value.trim();
          const phone = ui.phone.value.replace(/\D+/g,'');
          const street = ui.street.value.trim();
          const number = ui.number.value.trim();
          const district = ui.district.value;

          if (!name) return showError('Informe seu nome completo');
          if (phone.length !== 11) return showError('Telefone inv√°lido');
          if (!street) return showError('Informe o endere√ßo');
          if (!district) return showError('Selecione o bairro');

          localStorage.setItem('customer_name', name);
          localStorage.setItem('customer_phone', phone);
          localStorage.setItem('customer_street', street);
          localStorage.setItem('customer_number', number);
          localStorage.setItem('customer_district', district);
          localStorage.setItem('payment_method_id', ui.payment.value);

          const chosen = payOpts.find(p => p.id === ui.payment.value);
          const payDisc = calcPayDiscount(cart.totals.subtotal, chosen?.discount);
          const deliveryFee = Number(feeMap[district] || 0);

          close({
            name, phone, street, number, district,
            payment: chosen,
            paymentDiscountApplied: payDisc,
            deliveryFee
          });
        };

        function showError(msg){
          ui.error.textContent = msg;
          ui.error.style.display = 'block';
          setTimeout(() => ui.error.style.display = 'none', 3500);
        }
      });
    }

    function calcPayDiscount(subtotal, discount){
      if (!discount) return 0;
      const v = Number(discount.value||0);
      if (discount.type === 'percent') return +(subtotal * (v/100)).toFixed(2);
      if (discount.type === 'fixed') return +v.toFixed(2);
      return 0;
    }

    async function loadDistrictsAndFees(){
      let list = [];
      let fees = {};
      for (const url of ['./bairros.json','../bairros.json']) {
        try {
          const r = await fetch(url, { cache:'no-store' });
          if (!r.ok) continue;
          const d = await r.json();
          if (Array.isArray(d)) {
            list = d.map(s => String(s).trim()).filter(Boolean);
          } else if (d && typeof d === 'object') {
            for (const [k,v] of Object.entries(d)) {
              const name = String(k).trim();
              if (name) {
                list.push(name);
                fees[name] = Number(v) || 0;
              }
            }
          }
          break;
        } catch {}
      }
      list = Array.from(new Set(list)).sort((a,b)=> a.localeCompare(b,'pt-BR'));
      return { list, fees };
    }

    async function loadOrEnsurePaymentOptions(){
      try {
        const { db, ready } = await import('./server.js');
        await ready;
        const ref = db.collection('data').doc('keys');
        const snap = await ref.get();
        const d = snap.exists ? snap.data() : {};
        let arr = Array.isArray(d.paymentOptions) ? d.paymentOptions : [];
        if (!arr.length) {
          arr = [
            { id:'pix', name:'Pix', discount:{ type:'percent', value:5 } },
            { id:'debito', name:'D√©bito', discount:{ type:'percent', value:2 } },
            { id:'credito', name:'Cr√©dito', discount:{ type:'percent', value:0 } },
            { id:'dinheiro', name:'Dinheiro', discount:{ type:'fixed', value:0 } },
          ];
          await ref.set({ paymentOptions: arr }, { merge:true });
        }
        return arr;
      } catch {
        return [
          { id:'pix', name:'Pix', discount:{ type:'percent', value:5 } },
          { id:'dinheiro', name:'Dinheiro', discount:{ type:'fixed', value:0 } }
        ];
      }
    }

    function loadCart(){
      try{
        const raw = localStorage.getItem(LS_CART);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function saveCart(){
      localStorage.setItem(LS_CART, JSON.stringify(cart));
      localStorage.setItem(LS_CART_UPDATED, new Date().toISOString());
      renderCart();
    }

    function fromProduct(p){
      return {
        id: productId(p),
        name: p?.nome ?? '‚Äî',
        code: p?.codigoBarras ?? null,
        unitPrice: Number(productPrice(p) || 0),
        qty: 1
      };
    }

    function addToCart(item){
      const idx = cart.findIndex(it => it.id === item.id);
      if (idx >= 0) cart[idx].qty += item.qty;
      else cart.push(item);
      saveCart();
      els.cartPanel.classList.add('open');
    }

    function incItem(id, d){
      const it = cart.find(i => i.id === id);
      if (!it) return;
      it.qty = Math.max(1, it.qty + d);
      saveCart();
    }

    function removeItem(id){
      cart = cart.filter(i => i.id !== id);
      saveCart();
    }

    function renderCart(){
      const rows = cart.map(it => {
        const total = it.unitPrice * it.qty;
        return `
          <div class="cartItem">
            <div class="itemHeader">
              <div>
                <b>${it.name}</b>
                <div class="itemMeta">${it.code ? '#'+it.code+' ‚Ä¢ ' : ''}${moneyBR(it.unitPrice)}/un</div>
              </div>
              <div class="itemPrice">${moneyBR(total)}</div>
            </div>
            <div class="itemControls">
              <div class="qty">
                <button data-act="dec" data-id="${it.id}">‚àí</button>
                <b>${it.qty}</b>
                <button data-act="inc" data-id="${it.id}">Ôºã</button>
              </div>
              <button class="btn-del" data-act="del" data-id="${it.id}">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');

      els.cartBody.innerHTML = rows || '<div class="empty"><div class="empty-icon">üõí</div><div>Carrinho vazio</div></div>';
      const items = cart.reduce((s,i)=>s+i.qty,0);
      const total = cart.reduce((s,i)=>s+i.qty*i.unitPrice,0);
      els.cartItems.textContent = String(items);
      els.cartTotal.textContent = moneyBR(total);
      els.cartCount.textContent = String(items);
      els.cartCount.style.display = items > 0 ? 'block' : 'none';
    }
  </script>
</body>
</html>
